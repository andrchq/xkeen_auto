#!/bin/sh

SCRIPT_DIR="/opt/root/scripts"
GITHUB_RAW="https://raw.githubusercontent.com/andrchq/xkeen_auto/main"
VERSION_FILE="$SCRIPT_DIR/.version"
UPDATE_CHECK_FILE="/tmp/prosto_update_check"
SUBSCRIPTION_FILE="$SCRIPT_DIR/.subscription_url"
OPENED_PORTS_FILE="$SCRIPT_DIR/.opened_ports"
FAVORITE_COUNTRY_FILE="$SCRIPT_DIR/.favorite_country"
FORCED_COUNTRY_FILE="$SCRIPT_DIR/.forced_country"
AVAILABLE_DIR="/opt/etc/xray/outbounds_available"

GRAY="\033[90m"
BLUE="\033[94m"
GREEN="\033[92m"
YELLOW="\033[93m"
RED="\033[91m"
RESET="\033[0m"
BOLD="\033[1m"
ORANGE="\033[38;5;214m"
CYAN="\033[96m"

LINE="‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

show_header() {
    clear
    printf "${BLUE}${BOLD}ü§≤üèº –ü–†–û–°–¢–û–í–ü–ù${RESET}\n"
    printf "${ORANGE}${LINE}${RESET}\n"
    echo ""
}

show_section() {
    printf "\n${ORANGE}${LINE}${RESET}\n"
    printf "${BLUE}${BOLD}$1${RESET}\n"
    printf "${ORANGE}${LINE}${RESET}\n\n"
}

show_log() {
    printf "${CYAN}$1${RESET}\n"
}

show_countdown() {
    _SECS=${1:-3}
    while [ $_SECS -gt 0 ]; do
        printf "\r${YELLOW}[%d]${RESET} " "$_SECS"
        sleep 1
        _SECS=$((_SECS - 1))
    done
    printf "\r    \r"
}

get_subscription_url() {
    if [ -f "$SUBSCRIPTION_FILE" ]; then
        cat "$SUBSCRIPTION_FILE" 2>/dev/null | tr -d '\n\r'
    fi
}

save_subscription_url() {
    echo "$1" > "$SUBSCRIPTION_FILE"
}

# –ü–æ–ª—É—á–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é (–≥–ª–∞–≤–Ω—É—é)
get_local_version() {
    if [ -f "$VERSION_FILE" ]; then
        _CONTENT=$(cat "$VERSION_FILE" 2>/dev/null)
        # –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç —Å version:
        _VER=$(echo "$_CONTENT" | grep "^version:" | cut -d: -f2 | tr -d ' \n\r')
        if [ -n "$_VER" ]; then
            echo "$_VER"
        else
            # –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç - –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞
            echo "$_CONTENT" | head -n1 | tr -d '\n\r '
        fi
    else
        echo "0.0.0"
    fi
}

# –ü–æ–ª—É—á–∏—Ç—å –≤–µ—Ä—Å–∏—é –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
get_file_version() {
    _FILENAME="$1"
    if [ -f "$VERSION_FILE" ]; then
        _VER=$(grep "^${_FILENAME}:" "$VERSION_FILE" 2>/dev/null | cut -d: -f2 | tr -d ' \n\r')
        [ -n "$_VER" ] && echo "$_VER" || echo "0.0.0"
    else
        echo "0.0.0"
    fi
}

# –°—Ä–∞–≤–Ω–∏—Ç—å –≤–µ—Ä—Å–∏–∏ (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 0 –µ—Å–ª–∏ remote > local)
version_greater() {
    LOCAL_VER="$1"
    REMOTE_VER="$2"
    
    # –ü–∞—Ä—Å–∏–º –≤–µ—Ä—Å–∏–∏
    LOCAL_MAJOR=$(echo "$LOCAL_VER" | cut -d. -f1)
    LOCAL_MINOR=$(echo "$LOCAL_VER" | cut -d. -f2)
    LOCAL_PATCH=$(echo "$LOCAL_VER" | cut -d. -f3)
    
    REMOTE_MAJOR=$(echo "$REMOTE_VER" | cut -d. -f1)
    REMOTE_MINOR=$(echo "$REMOTE_VER" | cut -d. -f2)
    REMOTE_PATCH=$(echo "$REMOTE_VER" | cut -d. -f3)
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    [ -z "$LOCAL_MAJOR" ] && LOCAL_MAJOR=0
    [ -z "$LOCAL_MINOR" ] && LOCAL_MINOR=0
    [ -z "$LOCAL_PATCH" ] && LOCAL_PATCH=0
    [ -z "$REMOTE_MAJOR" ] && REMOTE_MAJOR=0
    [ -z "$REMOTE_MINOR" ] && REMOTE_MINOR=0
    [ -z "$REMOTE_PATCH" ] && REMOTE_PATCH=0
    
    # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º
    [ "$REMOTE_MAJOR" -gt "$LOCAL_MAJOR" ] && return 0
    [ "$REMOTE_MAJOR" -lt "$LOCAL_MAJOR" ] && return 1
    [ "$REMOTE_MINOR" -gt "$LOCAL_MINOR" ] && return 0
    [ "$REMOTE_MINOR" -lt "$LOCAL_MINOR" ] && return 1
    [ "$REMOTE_PATCH" -gt "$LOCAL_PATCH" ] && return 0
    return 1
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –ø–æ –≤–µ—Ä—Å–∏–∏
check_for_updates() {
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ —á–∞—â–µ —Ä–∞–∑–∞ –≤ —á–∞—Å
    if [ -f "$UPDATE_CHECK_FILE" ]; then
        LAST_CHECK=$(cat "$UPDATE_CHECK_FILE" 2>/dev/null)
        CURRENT_TIME=$(date +%s)
        if [ -n "$LAST_CHECK" ] && [ "$CURRENT_TIME" -lt "$((LAST_CHECK + 3600))" ]; then
            return 1
        fi
    fi
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    date +%s > "$UPDATE_CHECK_FILE"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
    if ! ping -c 1 -W 2 8.8.8.8 >/dev/null 2>&1; then
        return 1
    fi
    
    # –ü–æ–ª—É—á–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é
    LOCAL_VERSION=$(get_local_version)
    
    # –°–∫–∞—á–∏–≤–∞–µ–º —É–¥–∞–ª—ë–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
    REMOTE_CONTENT=$(curl -sL --max-time 5 "$GITHUB_RAW/VERSION" 2>/dev/null)
    REMOTE_VERSION=$(get_main_version "$REMOTE_CONTENT")
    
    if [ -z "$REMOTE_VERSION" ]; then
        return 1
    fi
    
    # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –≤–µ—Ä—Å–∏–∏
    if version_greater "$LOCAL_VERSION" "$REMOTE_VERSION"; then
        return 0
    fi
    
    return 1
}

# –ü–æ–ª—É—á–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ VERSION
get_update_type() {
    _VERSION_CONTENT="$1"
    echo "$_VERSION_CONTENT" | grep "^type:" | cut -d: -f2 | tr -d ' '
}

# –ü–æ–ª—É—á–∏—Ç—å –≥–ª–∞–≤–Ω—É—é –≤–µ—Ä—Å–∏—é –∏–∑ VERSION
get_main_version() {
    _VERSION_CONTENT="$1"
    echo "$_VERSION_CONTENT" | grep "^version:" | cut -d: -f2 | tr -d ' '
}

# –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
offer_update() {
    LOCAL_VERSION=$(get_local_version)
    REMOTE_CONTENT=$(curl -sL --max-time 5 "$GITHUB_RAW/VERSION" 2>/dev/null)
    REMOTE_VERSION=$(get_main_version "$REMOTE_CONTENT")
    UPDATE_TYPE=$(get_update_type "$REMOTE_CONTENT")
    
    # –¶–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    case "$UPDATE_TYPE" in
        critical)
            TYPE_COLOR="$RED"
            TYPE_TEXT="–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï"
            ;;
        recommended)
            TYPE_COLOR="$YELLOW"
            TYPE_TEXT="–†–ï–ö–û–ú–ï–ù–î–£–ï–ú–û–ï"
            ;;
        *)
            TYPE_COLOR="$GRAY"
            TYPE_TEXT="–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ"
            ;;
    esac
    
    show_section "üîÑ –î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ!"
    printf "–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è:  ${GRAY}${LOCAL_VERSION}${RESET}\n"
    printf "–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è:    ${GREEN}${REMOTE_VERSION}${RESET}\n"
    printf "–¢–∏–ø –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:  ${TYPE_COLOR}${TYPE_TEXT}${RESET}\n"
    printf "\n${ORANGE}${LINE}${RESET}\n\n"
    printf "${BLUE}–û–±–Ω–æ–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º—É —Å–µ–π—á–∞—Å? (y/n): ${RESET}"
    read -r answer
    if [ "$answer" = "y" ] || [ "$answer" = "Y" ]; then
        run_update
    fi
}

# –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ - —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
smart_update() {
    REMOTE_CONTENT="$1"
    
    show_section "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã"
    
    UPDATED_COUNT=0
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
    for _FILE in xkeen_rotate.sh xkeen_sync.sh network_watchdog.sh startup_notify.sh xkeen_restart.sh; do
        LOCAL_FILE_VER=$(get_file_version "$_FILE")
        REMOTE_FILE_VER=$(echo "$REMOTE_CONTENT" | grep "^${_FILE}:" | cut -d: -f2 | tr -d ' ')
        [ -z "$REMOTE_FILE_VER" ] && continue
        
        if version_greater "$LOCAL_FILE_VER" "$REMOTE_FILE_VER"; then
            printf "${CYAN}–û–±–Ω–æ–≤–ª—è—é $_FILE...${RESET} "
            if curl -sSL "$GITHUB_RAW/$_FILE" -o "$SCRIPT_DIR/$_FILE" 2>/dev/null; then
                chmod +x "$SCRIPT_DIR/$_FILE"
                printf "${GREEN}‚úì${RESET}\n"
                UPDATED_COUNT=$((UPDATED_COUNT + 1))
            else
                printf "${RED}‚úó${RESET}\n"
            fi
        fi
    done
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º prosto –æ—Ç–¥–µ–ª—å–Ω–æ (–æ–Ω –≤ /opt/bin)
    LOCAL_PROSTO_VER=$(get_file_version "prosto")
    REMOTE_PROSTO_VER=$(echo "$REMOTE_CONTENT" | grep "^prosto:" | cut -d: -f2 | tr -d ' ')
    
    if [ -n "$REMOTE_PROSTO_VER" ] && version_greater "$LOCAL_PROSTO_VER" "$REMOTE_PROSTO_VER"; then
        printf "${CYAN}–û–±–Ω–æ–≤–ª—è—é prosto...${RESET} "
        if curl -sSL "$GITHUB_RAW/prosto" -o "/opt/bin/prosto" 2>/dev/null; then
            chmod +x "/opt/bin/prosto"
            printf "${GREEN}‚úì${RESET}\n"
            UPDATED_COUNT=$((UPDATED_COUNT + 1))
        else
            printf "${RED}‚úó${RESET}\n"
        fi
    fi
    
    # –û–±–Ω–æ–≤–ª—è–µ–º VERSION —Ñ–∞–π–ª
    printf "${CYAN}–û–±–Ω–æ–≤–ª—è—é VERSION...${RESET} "
    if curl -sSL "$GITHUB_RAW/VERSION" -o "$VERSION_FILE" 2>/dev/null; then
        printf "${GREEN}‚úì${RESET}\n"
    else
        printf "${RED}‚úó${RESET}\n"
    fi
    
    printf "${ORANGE}${LINE}${RESET}\n\n"
    
    if [ $UPDATED_COUNT -gt 0 ]; then
        printf "${GREEN}‚úì –û–±–Ω–æ–≤–ª–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: $UPDATED_COUNT${RESET}\n"
        printf "${GRAY}–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ prosto –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π${RESET}\n"
    else
        printf "${GREEN}‚úì –í—Å–µ —Ñ–∞–π–ª—ã –∞–∫—Ç—É–∞–ª—å–Ω—ã${RESET}\n"
    fi
    
    rm -f "$UPDATE_CHECK_FILE"
}

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞)
run_update() {
    show_section "–ü–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ"
    printf "${CYAN}–ó–∞–ø—É—Å–∫–∞—é —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫...${RESET}\n"
    printf "${ORANGE}${LINE}${RESET}\n\n"
    rm -f "$UPDATE_CHECK_FILE"
    curl -sSL "$GITHUB_RAW/install.sh" | sh
    exit 0
}

# –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ—Ä—Ç–æ–≤ —Å —Ç–∞–π–º–∞—É—Ç–æ–º
run_xkeen_ap_with_timeout() {
    _PORTS="$1"
    _TIMEOUT=15
    _OUTPUT_FILE="/tmp/xkeen_ports_output_$$"
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–º–∞–Ω–¥—É –≤ —Ñ–æ–Ω–µ
    (xkeen -ap "$_PORTS" > "$_OUTPUT_FILE" 2>&1; echo $? > "${_OUTPUT_FILE}.exit") &
    _CMD_PID=$!
    
    # –ñ–¥—ë–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å —Ç–∞–π–º–∞—É—Ç–æ–º
    _WAITED=0
    while [ $_WAITED -lt $_TIMEOUT ]; do
        if ! kill -0 "$_CMD_PID" 2>/dev/null; then
            wait "$_CMD_PID" 2>/dev/null
            if [ -f "${_OUTPUT_FILE}.exit" ]; then
                _EXIT_CODE=$(cat "${_OUTPUT_FILE}.exit")
                cat "$_OUTPUT_FILE" 2>/dev/null
                rm -f "$_OUTPUT_FILE" "${_OUTPUT_FILE}.exit"
                return $_EXIT_CODE
            fi
            cat "$_OUTPUT_FILE" 2>/dev/null
            rm -f "$_OUTPUT_FILE" "${_OUTPUT_FILE}.exit"
            return 0
        fi
        sleep 1
        _WAITED=$((_WAITED + 1))
        printf "\r${GRAY}–û–∂–∏–¥–∞–Ω–∏–µ... %d/%d —Å–µ–∫${RESET}" "$_WAITED" "$_TIMEOUT"
    done
    
    # –¢–∞–π–º–∞—É—Ç
    printf "\n${YELLOW}‚ö† –¢–∞–π–º–∞—É—Ç! –ö–æ–º–∞–Ω–¥–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å –∑–∞ %d —Å–µ–∫—É–Ω–¥${RESET}\n" "$_TIMEOUT"
    kill -9 "$_CMD_PID" 2>/dev/null
    wait "$_CMD_PID" 2>/dev/null
    rm -f "$_OUTPUT_FILE" "${_OUTPUT_FILE}.exit"
    return 124
}

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ xkeen —Å —Ç–∞–π–º–∞—É—Ç–æ–º
run_xkeen_restart_with_timeout() {
    _TIMEOUT=10
    _OUTPUT_FILE="/tmp/xkeen_restart_output_$$"
    
    (xkeen -restart > "$_OUTPUT_FILE" 2>&1; echo $? > "${_OUTPUT_FILE}.exit") &
    _CMD_PID=$!
    
    _WAITED=0
    while [ $_WAITED -lt $_TIMEOUT ]; do
        if ! kill -0 "$_CMD_PID" 2>/dev/null; then
            wait "$_CMD_PID" 2>/dev/null
            if [ -f "${_OUTPUT_FILE}.exit" ]; then
                cat "$_OUTPUT_FILE" 2>/dev/null
                rm -f "$_OUTPUT_FILE" "${_OUTPUT_FILE}.exit"
                return 0
            fi
            cat "$_OUTPUT_FILE" 2>/dev/null
            rm -f "$_OUTPUT_FILE" "${_OUTPUT_FILE}.exit"
            return 0
        fi
        sleep 1
        _WAITED=$((_WAITED + 1))
    done
    
    # –¢–∞–π–º–∞—É—Ç - –Ω–æ –∫–æ–º–∞–Ω–¥–∞ —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –≤—ã–ø–æ–ª–Ω–∏–ª–∞—Å—å
    kill -9 "$_CMD_PID" 2>/dev/null
    wait "$_CMD_PID" 2>/dev/null
    cat "$_OUTPUT_FILE" 2>/dev/null
    rm -f "$_OUTPUT_FILE" "${_OUTPUT_FILE}.exit"
    return 0
}

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ xkeen –¥–ª—è –ø–æ—Ä—Ç–æ–≤
restart_xkeen_for_ports() {
    printf "${BLUE}–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ xkeen...${RESET}\n"
    run_xkeen_restart_with_timeout
    printf "${GREEN}‚úì xkeen –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω${RESET}\n"
    sleep 2
    return 0
}

# –û—Ç–∫—Ä—ã—Ç—å –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ—Ä—Ç—ã
open_ports() {
    PORTS_TO_OPEN="80,443,50000:50030"
    
    printf "${BLUE}–ü–æ—Ä—Ç—ã –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è: ${PORTS_TO_OPEN}${RESET}\n\n"
    printf "${YELLOW}–û—Ç–∫—Ä—ã—Ç—å —ç—Ç–∏ –ø–æ—Ä—Ç—ã? (y/n): ${RESET}"
    read -r answer
    
    if [ "$answer" = "y" ] || [ "$answer" = "Y" ]; then
        printf "\n${BLUE}–û—Ç–∫—Ä—ã–≤–∞—é –ø–æ—Ä—Ç—ã...${RESET}\n"
        printf "${GRAY}–¢–∞–π–º–∞—É—Ç: 15 —Å–µ–∫—É–Ω–¥${RESET}\n\n"
        
        if command -v xkeen >/dev/null 2>&1; then
            MAX_ATTEMPTS=3
            ATTEMPT=1
            PORTS_SUCCESS=0
            
            while [ $ATTEMPT -le $MAX_ATTEMPTS ] && [ $PORTS_SUCCESS -eq 0 ]; do
                printf "${BLUE}–ü–æ–ø—ã—Ç–∫–∞ $ATTEMPT –∏–∑ $MAX_ATTEMPTS...${RESET}\n"
                
                PORTS_OUTPUT=$(run_xkeen_ap_with_timeout "$PORTS_TO_OPEN")
                RESULT=$?
                
                echo ""
                
                if [ $RESULT -eq 124 ]; then
                    # –¢–∞–π–º–∞—É—Ç - –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º xkeen
                    printf "${YELLOW}–ö–æ–º–∞–Ω–¥–∞ –∑–∞–≤–∏—Å–ª–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é xkeen...${RESET}\n\n"
                    restart_xkeen_for_ports
                    echo ""
                    ATTEMPT=$((ATTEMPT + 1))
                    continue
                elif [ $RESULT -eq 0 ]; then
                    # –£—Å–ø–µ—Ö
                    echo "$PORTS_OUTPUT"
                    echo ""
                    
                    NEW_PORTS=$(echo "$PORTS_OUTPUT" | awk '/–ù–æ–≤—ã–µ –ø–æ—Ä—Ç—ã –ø—Ä–æ–∫—Å–∏-–∫–ª–∏–µ–Ω—Ç–∞/{found=1; next} /–ü—Ä–æ–∫—Å–∏-–∫–ª–∏–µ–Ω—Ç —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç/{found=0} found && /^[[:space:]]*[0-9]/{gsub(/^[[:space:]]+/, ""); print}' | tr '\n' ',' | sed 's/,$//')
                    if [ -n "$NEW_PORTS" ]; then
                        echo "$NEW_PORTS" > "$OPENED_PORTS_FILE"
                        printf "${GREEN}‚úì –ü–æ—Ä—Ç—ã —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä—ã—Ç—ã!${RESET}\n"
                        printf "${GRAY}–ù–æ–≤—ã–µ –ø–æ—Ä—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã: $NEW_PORTS${RESET}\n"
                    else
                        printf "${GREEN}‚úì –í—Å–µ –ø–æ—Ä—Ç—ã —É–∂–µ –±—ã–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã —Ä–∞–Ω–µ–µ${RESET}\n"
                    fi
                    PORTS_SUCCESS=1
                else
                    # –î—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞
                    printf "${RED}–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–æ—Ä—Ç–æ–≤ (–∫–æ–¥: $RESULT)${RESET}\n"
                    echo "$PORTS_OUTPUT"
                    ATTEMPT=$((ATTEMPT + 1))
                    
                    if [ $ATTEMPT -le $MAX_ATTEMPTS ]; then
                        printf "${YELLOW}–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é xkeen –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π...${RESET}\n"
                        restart_xkeen_for_ports
                        echo ""
                    fi
                fi
            done
            
            if [ $PORTS_SUCCESS -eq 0 ]; then
                printf "${RED}‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç—ã –ø–æ—Å–ª–µ $MAX_ATTEMPTS –ø–æ–ø—ã—Ç–æ–∫${RESET}\n"
            fi
        else
            printf "${RED}–û—à–∏–±–∫–∞: xkeen –Ω–µ –Ω–∞–π–¥–µ–Ω${RESET}\n"
        fi
    else
        printf "${GRAY}–û—Ç–º–µ–Ω–µ–Ω–æ.${RESET}\n"
    fi
}

# –ó–∞–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç—ã, –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ
close_opened_ports() {
    if [ ! -f "$OPENED_PORTS_FILE" ]; then
        printf "${YELLOW}–§–∞–π–ª —Å –æ—Ç–∫—Ä—ã—Ç—ã–º–∏ –ø–æ—Ä—Ç–∞–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω.${RESET}\n"
        printf "${GRAY}–í–æ–∑–º–æ–∂–Ω–æ, –ø–æ—Ä—Ç—ã –Ω–µ –±—ã–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ.${RESET}\n"
        return 1
    fi
    
    PORTS_TO_CLOSE=$(cat "$OPENED_PORTS_FILE" 2>/dev/null | tr -d '\n\r ')
    
    if [ -z "$PORTS_TO_CLOSE" ]; then
        printf "${YELLOW}–°–ø–∏—Å–æ–∫ –ø–æ—Ä—Ç–æ–≤ –ø—É—Å—Ç.${RESET}\n"
        printf "${GRAY}–ü—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –Ω–µ –±—ã–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã –Ω–æ–≤—ã–µ –ø–æ—Ä—Ç—ã.${RESET}\n"
        return 1
    fi
    
    printf "${BLUE}–ü–æ—Ä—Ç—ã, –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ: ${PORTS_TO_CLOSE}${RESET}\n\n"
    printf "${YELLOW}–ó–∞–∫—Ä—ã—Ç—å —ç—Ç–∏ –ø–æ—Ä—Ç—ã? (y/n): ${RESET}"
    read -r answer
    
    if [ "$answer" = "y" ] || [ "$answer" = "Y" ]; then
        printf "\n${BLUE}–ó–∞–∫—Ä—ã–≤–∞—é –ø–æ—Ä—Ç—ã...${RESET}\n"
        printf "${GRAY}–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –æ–∫–æ–ª–æ 20 —Å–µ–∫—É–Ω–¥...${RESET}\n\n"
        
        if command -v xkeen >/dev/null 2>&1; then
            xkeen -dp "$PORTS_TO_CLOSE"
            RESULT=$?
            echo ""
            if [ $RESULT -eq 0 ]; then
                rm -f "$OPENED_PORTS_FILE"
                printf "${GREEN}‚úì –ü–æ—Ä—Ç—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä—ã—Ç—ã!${RESET}\n"
            else
                printf "${RED}–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ø–æ—Ä—Ç–æ–≤ (–∫–æ–¥: $RESULT)${RESET}\n"
            fi
        else
            printf "${RED}–û—à–∏–±–∫–∞: xkeen –Ω–µ –Ω–∞–π–¥–µ–Ω${RESET}\n"
        fi
    else
        printf "${GRAY}–û—Ç–º–µ–Ω–µ–Ω–æ.${RESET}\n"
    fi
}

# –ü–æ–ª—É—á–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω—É
get_favorite_country() {
    if [ -f "$FAVORITE_COUNTRY_FILE" ]; then
        cat "$FAVORITE_COUNTRY_FILE" 2>/dev/null | tr -d '\n\r '
    fi
}

# –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω—É
get_forced_country() {
    if [ -f "$FORCED_COUNTRY_FILE" ]; then
        LINE=$(cat "$FORCED_COUNTRY_FILE" 2>/dev/null)
        CC="${LINE%%:*}"
        TIMESTAMP="${LINE##*:}"
        if [ -n "$CC" ] && [ -n "$TIMESTAMP" ]; then
            CURRENT_TIME=$(date +%s)
            TIME_DIFF=$((CURRENT_TIME - TIMESTAMP))
            if [ "$TIME_DIFF" -lt 300 ]; then
                echo "$CC"
            fi
        fi
    fi
}

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å–µ—Ä–≤–µ—Ä
is_technical_server() {
    CC="$1"
    # RUSSIA/–†–æ—Å—Å–∏—è –Ω–µ –∞–∫—Ç—É–∞–ª—å–Ω–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã –Ω–∞ —Ä–æ—É—Ç–µ—Ä–µ - –∏—Å–∫–ª—é—á–∞–µ–º
    echo "$CC" | grep -qiE "^(RUSSIA|Russia|RU)$" && return 0
    TECHNICAL_NAMES="WIFI|WiFi|wifi|PROXY|proxy|TEST|test|LOCAL|local|VPN|vpn|SERVER|server|NODE|node|DIRECT|direct|BLOCK|block|REJECT|reject|AUTO|auto|BEST|best|FAST|fast|LOAD|load|BALANCE|balance"
    echo "$CC" | grep -qiE "^($TECHNICAL_NAMES)$" && return 0
    echo "$CC" | grep -q '%' && return 0
    echo "$CC" | grep -qE '^[0-9_a-z]+$' && return 0
    echo "$CC" | grep -q '\.' && return 0
    echo "$CC" | grep -qE '[\[\]]' && return 0
    CC_LEN=$(echo "$CC" | wc -c)
    [ "$CC_LEN" -lt 3 ] || [ "$CC_LEN" -gt 15 ] && return 0
    # RUSSIA|RU –∏—Å–∫–ª—é—á–µ–Ω–∞ - –Ω–µ –∞–∫—Ç—É–∞–ª—å–Ω–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã –Ω–∞ —Ä–æ—É—Ç–µ—Ä–µ
    VALID_COUNTRIES="USA|US|GERMANY|DE|FRANCE|FR|NETHERLANDS|NL|UK|GB|JAPAN|JP|SINGAPORE|SG|CANADA|CA|AUSTRALIA|AU|BRAZIL|BR|INDIA|IN|CHINA|CN|KOREA|KR|ITALY|IT|SPAIN|ES|POLAND|PL|SWEDEN|SE|NORWAY|NO|FINLAND|FI|DENMARK|DK|AUSTRIA|AT|SWITZERLAND|CH|BELGIUM|BE|IRELAND|IE|PORTUGAL|PT|GREECE|GR|CZECH|CZ|ROMANIA|RO|HUNGARY|HU|BULGARIA|BG|UKRAINE|UA|TURKEY|TR|ISRAEL|IL|UAE|DUBAI|HONG|HK|TAIWAN|TW|THAILAND|TH|VIETNAM|VN|INDONESIA|ID|MALAYSIA|MY|PHILIPPINES|PH|MEXICO|MX|ARGENTINA|AR|CHILE|CL|COLOMBIA|CO|PERU|PE|SOUTH|AFRICA|ZA|EGYPT|EG|MOROCCO|MA|NIGERIA|NG|KENYA|KE|LITVA|LATVIA|LV|LITHUANIA|LT|ESTONIA|EE|KAZAHSTAN|KAZAKHSTAN|KZ|UZBEKISTAN|UZ|GEORGIA|ARMENIA|AM|AZERBAIJAN|AZ|BELARUS|BY|MOLDOVA|MD|SERBIA|RS|CROATIA|HR|SLOVENIA|SI|SLOVAKIA|SK|CYPRUS|CY|MALTA|MT|LUXEMBOURG|LU|ICELAND|MOSCOW|BERLIN|LONDON|PARIS|AMSTERDAM|TOKYO|SEOUL|BEIJING|SHANGHAI|MUMBAI|SYDNEY|TORONTO|VANCOUVER|MIAMI|DALLAS|CHICAGO|ATLANTA|SEATTLE|DENVER|PHOENIX|BOSTON|WASHINGTON|NEWYORK|LOSANGELES|SANFRANCISCO|FRANKFURT|MUNICH|VIENNA|ZURICH|GENEVA|BRUSSELS|DUBLIN|LISBON|MADRID|BARCELONA|ROME|MILAN|PRAGUE|WARSAW|BUDAPEST|BUCHAREST|SOFIA|HELSINKI|STOCKHOLM|OSLO|COPENHAGEN"
    echo "$CC" | grep -qiE "^($VALID_COUNTRIES)" && return 1
    return 0
}

# –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ç—Ä–∞–Ω
get_available_countries() {
    for f in "${AVAILABLE_DIR}"/04_outbounds_*.json; do
        [ -f "$f" ] || continue
        CC=$(basename "$f" | sed -n 's/^04_outbounds_\([^.]*\)\.json$/\1/p')
        [ -z "$CC" ] && continue
        is_technical_server "$CC" && continue
        echo "$CC"
    done
}

# –í—ã–±—Ä–∞—Ç—å —Å—Ç—Ä–∞–Ω—É –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ
select_country_menu() {
    TITLE="$1"
    printf "${BLUE}${BOLD}${TITLE}${RESET}\n\n"
    
    FAVORITE=$(get_favorite_country)
    FORCED=$(get_forced_country)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å—Ç—Ä–∞–Ω
    COUNTRY_LIST=$(get_available_countries | sort)
    if [ -z "$COUNTRY_LIST" ]; then
        printf "${YELLOW}–°–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω –ø—É—Å—Ç!${RESET}\n\n"
        printf "${GRAY}–°—Ç—Ä–∞–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –ø–∞–ø–∫–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π.${RESET}\n"
        SAVED_URL=$(get_subscription_url)
        if [ -n "$SAVED_URL" ]; then
            printf "${BLUE}–í—ã–ø–æ–ª–Ω–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –ø–æ–¥–ø–∏—Å–∫–∏? (y/n): ${RESET}"
            read -r dosync
            if [ "$dosync" = "y" ] || [ "$dosync" = "Y" ]; then
                sh $SCRIPT_DIR/xkeen_rotate.sh --sync-url="$SAVED_URL"
                # –ü–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                COUNTRY_LIST=$(get_available_countries | sort)
            fi
        else
            printf "${RED}URL –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!${RESET}\n"
            printf "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—É–Ω–∫—Ç 7 –º–µ–Ω—é –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Å—ã–ª–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏.\n"
        fi
        if [ -z "$COUNTRY_LIST" ]; then
            SELECTED_COUNTRY=""
            return 1
        fi
    fi
    
    printf "${GRAY}–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç—Ä–∞–Ω—ã:${RESET}\n\n"
    
    i=1
    COUNTRIES_FILE="/tmp/prosto_countries_$$"
    : > "$COUNTRIES_FILE"
    for CC in $COUNTRY_LIST; do
        MARKS=""
        [ "$CC" = "$FAVORITE" ] && MARKS=" [‚òÖ –∏–∑–±—Ä–∞–Ω–Ω–∞—è]"
        [ "$CC" = "$FORCED" ] && MARKS=" [‚ö° –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è]"
        printf "  ${BLUE}%2d)${RESET} %s${YELLOW}%s${RESET}\n" "$i" "$CC" "$MARKS"
        echo "$CC" >> "$COUNTRIES_FILE"
        i=$((i + 1))
    done
    
    echo ""
    printf "${BLUE}–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω—ã (0 –¥–ª—è –æ—Ç–º–µ–Ω—ã): ${RESET}"
    read -r choice
    
    if [ "$choice" = "0" ] || [ -z "$choice" ]; then
        rm -f "$COUNTRIES_FILE"
        SELECTED_COUNTRY=""
        return 1
    fi
    
    SELECTED_COUNTRY=$(sed -n "${choice}p" "$COUNTRIES_FILE")
    rm -f "$COUNTRIES_FILE"
    if [ -n "$SELECTED_COUNTRY" ]; then
        return 0
    fi
    SELECTED_COUNTRY=""
    return 1
}

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω—É
set_favorite_interactive() {
    select_country_menu "–í—ã–±–æ—Ä –∏–∑–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω—ã"
    if [ $? -eq 0 ] && [ -n "$SELECTED_COUNTRY" ]; then
        echo "$SELECTED_COUNTRY" > "$FAVORITE_COUNTRY_FILE"
        printf "\n${GREEN}‚úì –ò–∑–±—Ä–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: $SELECTED_COUNTRY${RESET}\n"
        printf "${GRAY}–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∞ –±—É–¥–µ—Ç –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ –ø—Ä–∏ —Ä–æ—Ç–∞—Ü–∏–∏, –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ ping.${RESET}\n"
    else
        printf "\n${GRAY}–û—Ç–º–µ–Ω–µ–Ω–æ.${RESET}\n"
    fi
}

# –°–±—Ä–æ—Å–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω—É
clear_favorite() {
    if [ -f "$FAVORITE_COUNTRY_FILE" ]; then
        rm -f "$FAVORITE_COUNTRY_FILE"
        printf "${GREEN}‚úì –ò–∑–±—Ä–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∞ —Å–±—Ä–æ—à–µ–Ω–∞.${RESET}\n"
    else
        printf "${GRAY}–ò–∑–±—Ä–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∞ –Ω–µ –±—ã–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.${RESET}\n"
    fi
}

# –í—ã–±—Ä–∞—Ç—å —Å—Ç—Ä–∞–Ω—É –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ
set_forced_interactive() {
    select_country_menu "–í—ã–±—Ä–∞—Ç—å —Å—Ç—Ä–∞–Ω—É –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ"
    if [ $? -eq 0 ] && [ -n "$SELECTED_COUNTRY" ]; then
        TIMESTAMP=$(date +%s)
        echo "${SELECTED_COUNTRY}:${TIMESTAMP}" > "$FORCED_COUNTRY_FILE"
        printf "\n${GREEN}‚úì –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤—ã–±—Ä–∞–Ω–∞ —Å—Ç—Ä–∞–Ω–∞: $SELECTED_COUNTRY${RESET}\n"
        printf "${GRAY}–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∞ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è 5 –º–∏–Ω—É—Ç –∏–ª–∏ –¥–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏.${RESET}\n"
        echo ""
        printf "${BLUE}–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å? (y/n): ${RESET}"
        read -r activate
        if [ "$activate" = "y" ] || [ "$activate" = "Y" ]; then
            sh $SCRIPT_DIR/xkeen_rotate.sh --country="$SELECTED_COUNTRY" --force --verbose
        fi
    else
        printf "\n${GRAY}–û—Ç–º–µ–Ω–µ–Ω–æ.${RESET}\n"
    fi
}

# –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–±–æ—Ä
clear_forced() {
    if [ -f "$FORCED_COUNTRY_FILE" ]; then
        rm -f "$FORCED_COUNTRY_FILE"
        printf "${GREEN}‚úì –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–±–æ—Ä —Å–±—Ä–æ—à–µ–Ω.${RESET}\n"
    else
        printf "${GRAY}–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–±–æ—Ä –Ω–µ –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.${RESET}\n"
    fi
}

# –ú–µ–Ω—é –∏–∑–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω—ã
favorite_menu() {
    show_header
    show_section "–ò–∑–±—Ä–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∞"
    
    FAVORITE=$(get_favorite_country)
    if [ -n "$FAVORITE" ]; then
        printf "–¢–µ–∫—É—â–∞—è –∏–∑–±—Ä–∞–Ω–Ω–∞—è: ${YELLOW}‚òÖ $FAVORITE${RESET}\n\n"
    else
        printf "${GRAY}–ò–∑–±—Ä–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.${RESET}\n\n"
    fi
    
    printf "${BLUE}1)${RESET} –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω—É\n"
    printf "${BLUE}2)${RESET} –°–±—Ä–æ—Å–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω—É\n"
    printf "${BLUE}0)${RESET} –ù–∞–∑–∞–¥\n"
    printf "${ORANGE}${LINE}${RESET}\n"
    printf "${BLUE}–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ: ${RESET}"
    read -r choice
    
    case $choice in
        1)
            show_header
            set_favorite_interactive
            ;;
        2)
            clear_favorite
            ;;
        0|*)
            return
            ;;
    esac
}

# –ú–µ–Ω—é –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
forced_menu() {
    show_header
    show_section "–í—ã–±—Ä–∞—Ç—å —Å—Ç—Ä–∞–Ω—É –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ"
    
    FORCED=$(get_forced_country)
    if [ -n "$FORCED" ]; then
        printf "–¢–µ–∫—É—â–∏–π –≤—ã–±–æ—Ä: ${CYAN}‚ö° $FORCED${RESET}\n"
        printf "${GRAY}(—Å–±—Ä–æ—Å–∏—Ç—Å—è —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç –∏–ª–∏ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏)${RESET}\n\n"
    else
        printf "${GRAY}–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–±–æ—Ä –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.${RESET}\n\n"
    fi
    
    printf "${BLUE}1)${RESET} –í—ã–±—Ä–∞—Ç—å —Å—Ç—Ä–∞–Ω—É –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ\n"
    printf "${BLUE}2)${RESET} –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–±–æ—Ä\n"
    printf "${BLUE}0)${RESET} –ù–∞–∑–∞–¥\n"
    printf "${ORANGE}${LINE}${RESET}\n"
    printf "${BLUE}–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ: ${RESET}"
    read -r choice
    
    case $choice in
        1)
            show_header
            set_forced_interactive
            ;;
        2)
            clear_forced
            ;;
        0|*)
            return
            ;;
    esac
}

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
force_check_updates() {
    show_section "–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π"
    rm -f "$UPDATE_CHECK_FILE"
    
    if ! ping -c 1 -W 2 8.8.8.8 >/dev/null 2>&1; then
        printf "${RED}–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É${RESET}\n"
        return 1
    fi
    
    LOCAL_VERSION=$(get_local_version)
    printf "–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: ${GRAY}${LOCAL_VERSION}${RESET}\n"
    
    printf "–ü—Ä–æ–≤–µ—Ä—è—é —É–¥–∞–ª—ë–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é... "
    REMOTE_CONTENT=$(curl -sL --max-time 5 "$GITHUB_RAW/VERSION" 2>/dev/null)
    REMOTE_VERSION=$(get_main_version "$REMOTE_CONTENT")
    UPDATE_TYPE=$(get_update_type "$REMOTE_CONTENT")
    
    if [ -z "$REMOTE_VERSION" ]; then
        printf "${RED}–æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏${RESET}\n"
        return 1
    fi
    
    printf "${GREEN}${REMOTE_VERSION}${RESET}\n"
    printf "${ORANGE}${LINE}${RESET}\n\n"
    
    if version_greater "$LOCAL_VERSION" "$REMOTE_VERSION"; then
        # –¶–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
        case "$UPDATE_TYPE" in
            critical)
                TYPE_COLOR="$RED"
                TYPE_TEXT="–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï"
                ;;
            recommended)
                TYPE_COLOR="$YELLOW"
                TYPE_TEXT="–†–ï–ö–û–ú–ï–ù–î–£–ï–ú–û–ï"
                ;;
            *)
                TYPE_COLOR="$GRAY"
                TYPE_TEXT="–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ"
                ;;
        esac
        
        printf "${GREEN}–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: ${REMOTE_VERSION}${RESET}\n"
        printf "–¢–∏–ø –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${TYPE_COLOR}${TYPE_TEXT}${RESET}\n\n"
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫–∏–µ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã
        printf "${GRAY}–§–∞–π–ª—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:${RESET}\n"
        for _FILE in prosto xkeen_rotate.sh xkeen_sync.sh network_watchdog.sh startup_notify.sh xkeen_restart.sh; do
            LOCAL_FILE_VER=$(get_file_version "$_FILE")
            REMOTE_FILE_VER=$(echo "$REMOTE_CONTENT" | grep "^${_FILE}:" | cut -d: -f2 | tr -d ' ')
            [ -z "$REMOTE_FILE_VER" ] && continue
            if version_greater "$LOCAL_FILE_VER" "$REMOTE_FILE_VER"; then
                printf "  ${CYAN}$_FILE${RESET}: $LOCAL_FILE_VER ‚Üí ${GREEN}$REMOTE_FILE_VER${RESET}\n"
            fi
        done
        
        printf "\n${BLUE}–û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å? (y/n): ${RESET}"
        read -r answer
        if [ "$answer" = "y" ] || [ "$answer" = "Y" ]; then
            smart_update "$REMOTE_CONTENT"
        fi
    else
        printf "${GREEN}‚úì –£ –≤–∞—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è!${RESET}\n"
    fi
}

show_menu() {
    show_header
    LOCAL_VERSION=$(get_local_version)
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    FAVORITE=$(get_favorite_country)
    FORCED=$(get_forced_country)
    
    printf "${GRAY}v${LOCAL_VERSION}${RESET}\n"
    if [ -n "$FAVORITE" ] || [ -n "$FORCED" ]; then
        [ -n "$FAVORITE" ] && printf "${YELLOW}‚òÖ –ò–∑–±—Ä–∞–Ω–Ω–∞—è: $FAVORITE${RESET}  "
        [ -n "$FORCED" ] && printf "${CYAN}‚ö° –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è: $FORCED${RESET}"
        echo ""
    fi
    printf "${ORANGE}${LINE}${RESET}\n\n"
    printf "${BLUE}1)${RESET} –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–æ–≤\n"
    printf "${BLUE}2)${RESET} –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è\n"
    printf "${BLUE}3)${RESET} –í—ã–±—Ä–∞—Ç—å —Å—Ç—Ä–∞–Ω—É –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ\n"
    printf "${BLUE}4)${RESET} –ò–∑–±—Ä–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∞\n"
    printf "${BLUE}5)${RESET} –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ\n"
    printf "${BLUE}6)${RESET} –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏\n"
    printf "${BLUE}7)${RESET} –°–º–µ–Ω–∞ —Å—Å—ã–ª–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏\n"
    printf "${BLUE}8)${RESET} –û—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤\n"
    printf "${BLUE}9)${RESET} –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è\n"
    printf "${BLUE}10)${RESET} –û—Ç–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç—ã\n"
    printf "${BLUE}11)${RESET} –ó–∞–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç—ã\n"
    printf "${BLUE}12)${RESET} –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ xkeen\n"
    printf "${BLUE}13)${RESET} –û —Å–∏—Å—Ç–µ–º–µ\n"
    printf "${BLUE}0)${RESET} –í—ã—Ö–æ–¥\n"
    printf "${ORANGE}${LINE}${RESET}\n"
    printf "${BLUE}–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ: ${RESET}"
}

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ –∏–∑ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
if [ "$1" = "status" ]; then
    sh $SCRIPT_DIR/xkeen_rotate.sh --status
    exit 0
elif [ "$1" = "force" ]; then
    sh $SCRIPT_DIR/xkeen_rotate.sh --force --verbose
    exit 0
elif [ "$1" = "test" ]; then
    sh $SCRIPT_DIR/xkeen_rotate.sh --test-notify
    exit 0
elif [ "$1" = "sync" ]; then
    SAVED_URL=$(get_subscription_url)
    if [ -n "$SAVED_URL" ]; then
        sh $SCRIPT_DIR/xkeen_rotate.sh --sync-url="$SAVED_URL"
    else
        printf "${RED}–û—à–∏–±–∫–∞: URL –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.${RESET}\n"
        echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: prosto seturl <URL>"
    fi
    exit 0
elif [ "$1" = "seturl" ]; then
    if [ -n "$2" ]; then
        save_subscription_url "$2"
        printf "${GREEN}URL –ø–æ–¥–ø–∏—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω.${RESET}\n"
    else
        echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: prosto seturl <URL>"
    fi
    exit 0
elif [ "$1" = "cleanup" ]; then
    sh $SCRIPT_DIR/xkeen_rotate.sh --cleanup
    exit 0
elif [ "$1" = "country" ]; then
    if [ -n "$2" ]; then
        sh $SCRIPT_DIR/xkeen_rotate.sh --set-forced="$2"
        sh $SCRIPT_DIR/xkeen_rotate.sh --country="$2" --force --verbose
    else
        sh $SCRIPT_DIR/xkeen_rotate.sh --list-countries
    fi
    exit 0
elif [ "$1" = "favorite" ]; then
    if [ -n "$2" ]; then
        sh $SCRIPT_DIR/xkeen_rotate.sh --set-favorite="$2"
    else
        FAVORITE=$(get_favorite_country)
        if [ -n "$FAVORITE" ]; then
            printf "–ò–∑–±—Ä–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∞: ${YELLOW}‚òÖ $FAVORITE${RESET}\n"
        else
            echo "–ò–∑–±—Ä–∞–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞."
            echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: prosto favorite <–°–¢–†–ê–ù–ê>"
        fi
    fi
    exit 0
elif [ "$1" = "clearfavorite" ]; then
    sh $SCRIPT_DIR/xkeen_rotate.sh --clear-favorite
    exit 0
elif [ "$1" = "clearforced" ]; then
    sh $SCRIPT_DIR/xkeen_rotate.sh --clear-forced
    exit 0
elif [ "$1" = "openports" ]; then
    show_header
    printf "${BLUE}${BOLD}–û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ—Ä—Ç–æ–≤${RESET}\n\n"
    open_ports
    exit 0
elif [ "$1" = "closeports" ]; then
    show_header
    printf "${BLUE}${BOLD}–ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ—Ä—Ç–æ–≤${RESET}\n\n"
    close_opened_ports
    exit 0
elif [ "$1" = "update" ]; then
    show_header
    force_check_updates
    exit 0
elif [ "$1" = "version" ]; then
    LOCAL_VERSION=$(get_local_version)
    echo "–ø—Ä–æ—Å—Ç–æ–≤–ø–Ω v${LOCAL_VERSION}"
    exit 0
elif [ -n "$1" ]; then
    echo "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: $1"
    echo ""
    echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
    echo "  prosto                 - –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –º–µ–Ω—é"
    echo "  prosto status          - –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å"
    echo "  prosto force           - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è"
    echo "  prosto country <XX>    - –≤—ã–±—Ä–∞—Ç—å —Å—Ç—Ä–∞–Ω—É –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ"
    echo "  prosto favorite <XX>   - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω—É"
    echo "  prosto clearfavorite   - —Å–±—Ä–æ—Å–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω—É"
    echo "  prosto clearforced     - —Å–±—Ä–æ—Å–∏—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–±–æ—Ä"
    echo "  prosto test            - —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
    echo "  prosto sync            - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π URL)"
    echo "  prosto seturl <URL>    - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å URL –ø–æ–¥–ø–∏—Å–∫–∏"
    echo "  prosto cleanup         - –æ—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤"
    echo "  prosto openports       - –æ—Ç–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç—ã"
    echo "  prosto closeports      - –∑–∞–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç—ã"
    echo "  prosto update          - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
    echo "  prosto version         - –ø–æ–∫–∞–∑–∞—Ç—å –≤–µ—Ä—Å–∏—é"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ (–Ω–µ —á–∞—â–µ —Ä–∞–∑–∞ –≤ —á–∞—Å)
if check_for_updates; then
    show_header
    offer_update
fi

# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –º–µ–Ω—é
while true; do
    show_menu
    read -r choice
    
    case $choice in
        1)
            show_header
            show_section "–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–æ–≤"
            show_log "$(sh $SCRIPT_DIR/xkeen_rotate.sh --status)"
            printf "${ORANGE}${LINE}${RESET}\n"
            printf "${BLUE}–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é...${RESET}"
            read -r dummy
            ;;
        2)
            show_header
            show_section "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è"
            sh $SCRIPT_DIR/xkeen_rotate.sh --force --verbose
            printf "${ORANGE}${LINE}${RESET}\n"
            printf "${BLUE}–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é...${RESET}"
            read -r dummy
            ;;
        3)
            forced_menu
            echo ""
            printf "${BLUE}–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é...${RESET}"
            read -r dummy
            ;;
        4)
            favorite_menu
            echo ""
            printf "${BLUE}–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é...${RESET}"
            read -r dummy
            ;;
        5)
            show_header
            show_section "–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
            sh $SCRIPT_DIR/xkeen_rotate.sh --test-notify
            printf "${ORANGE}${LINE}${RESET}\n"
            printf "${BLUE}–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é...${RESET}"
            read -r dummy
            ;;
        6)
            show_header
            show_section "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏"
            SAVED_URL=$(get_subscription_url)
            if [ -n "$SAVED_URL" ]; then
                show_log "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è..."
                sh $SCRIPT_DIR/xkeen_rotate.sh --sync-url="$SAVED_URL"
            else
                printf "${RED}URL –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!${RESET}\n"
                printf "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—É–Ω–∫—Ç 7 –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Å—ã–ª–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏.\n"
            fi
            printf "${ORANGE}${LINE}${RESET}\n"
            printf "${BLUE}–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é...${RESET}"
            read -r dummy
            ;;
        7)
            show_header
            show_section "–°–º–µ–Ω–∞ —Å—Å—ã–ª–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏"
            CURRENT_URL=$(get_subscription_url)
            if [ -n "$CURRENT_URL" ]; then
                printf "${GRAY}–¢–µ–∫—É—â–∞—è —Å—Å—ã–ª–∫–∞: ${CURRENT_URL}${RESET}\n\n"
            fi
            printf "${BLUE}–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π URL –ø–æ–¥–ø–∏—Å–∫–∏: ${RESET}"
            read -r url
            if [ -n "$url" ]; then
                save_subscription_url "$url"
                printf "${GREEN}URL –ø–æ–¥–ø–∏—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!${RESET}\n"
                printf "${ORANGE}${LINE}${RESET}\n"
                printf "${BLUE}–í—ã–ø–æ–ª–Ω–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å–µ–π—á–∞—Å? (y/n): ${RESET}"
                read -r dosync
                if [ "$dosync" = "y" ] || [ "$dosync" = "Y" ]; then
                    sh $SCRIPT_DIR/xkeen_rotate.sh --sync-url="$url"
                fi
            else
                printf "${YELLOW}URL –Ω–µ –≤–≤–µ–¥—ë–Ω, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.${RESET}\n"
            fi
            printf "${ORANGE}${LINE}${RESET}\n"
            printf "${BLUE}–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é...${RESET}"
            read -r dummy
            ;;
        8)
            show_header
            show_section "–û—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤"
            sh $SCRIPT_DIR/xkeen_rotate.sh --cleanup
            printf "${ORANGE}${LINE}${RESET}\n"
            printf "${BLUE}–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é...${RESET}"
            read -r dummy
            ;;
        9)
            show_header
            force_check_updates
            printf "${ORANGE}${LINE}${RESET}\n"
            printf "${BLUE}–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é...${RESET}"
            read -r dummy
            ;;
        10)
            show_header
            show_section "–û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ—Ä—Ç–æ–≤"
            open_ports
            printf "${ORANGE}${LINE}${RESET}\n"
            printf "${BLUE}–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é...${RESET}"
            read -r dummy
            ;;
        11)
            show_header
            show_section "–ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ—Ä—Ç–æ–≤"
            close_opened_ports
            printf "${ORANGE}${LINE}${RESET}\n"
            printf "${BLUE}–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é...${RESET}"
            read -r dummy
            ;;
        12)
            show_header
            show_section "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ xkeen"
            printf "${YELLOW}–í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ xkeen? (y/n): ${RESET}"
            read -r confirm
            if [ "$confirm" = "y" ] || [ "$confirm" = "Y" ]; then
                show_log "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ xkeen..."
                run_xkeen_restart_with_timeout
                printf "${GREEN}‚úì xkeen –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω${RESET}\n"
            else
                printf "${GRAY}–û—Ç–º–µ–Ω–µ–Ω–æ.${RESET}\n"
            fi
            printf "${ORANGE}${LINE}${RESET}\n"
            printf "${BLUE}–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é...${RESET}"
            read -r dummy
            ;;
        13)
            show_header
            show_section "–û —Å–∏—Å—Ç–µ–º–µ"
            LOCAL_VERSION=$(get_local_version)
            printf "–í–µ—Ä—Å–∏—è: ${GRAY}${LOCAL_VERSION}${RESET}\n\n"
            printf "–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ –∫–æ–º–∞–Ω–¥–æ–π ${BLUE}${BOLD}–ø—Ä–æ—Å—Ç–æ–≤–ø–Ω${RESET}\n\n"
            printf "${GREEN}–ü–æ–∫—É–ø–∫–∞:${RESET} https://t.me/prstabot\n"
            printf "${GREEN}–ü–æ–¥–¥–µ—Ä–∂–∫–∞:${RESET} https://t.me/prsta_helpbot\n"
            printf "${GREEN}GitHub:${RESET} https://github.com/andrchq/xkeen_auto\n"
            printf "${ORANGE}${LINE}${RESET}\n"
            printf "${BLUE}–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é...${RESET}"
            read -r dummy
            ;;
        0)
            show_header
            printf "${GREEN}–î–æ —Å–≤–∏–¥–∞–Ω–∏—è!${RESET}\n\n"
            exit 0
            ;;
        *)
            show_header
            printf "${YELLOW}–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä.${RESET}\n"
            show_countdown 2
            ;;
    esac
done
